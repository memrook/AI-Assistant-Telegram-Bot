# Телеграм-бот AI-ассистент с поиском по документам

Данное приложение реализует функционал AI-ассистента с гибридным поиском по документам на основе Yandex Cloud ML SDK. Ассистент работает в виде телеграм-бота и использует технологии Yandex Cloud для работы с Markdown-документами и поиска информации в них.

## Особенности

- Загрузка готовых Markdown-файлов в Yandex Cloud и создание гибридного поискового индекса
- Сохранение ID поискового индекса для повторного использования без переиндексации
- Управление сессиями пользователей в телеграм-боте (каждый пользователь общается с AI моделью внутри своего треда)
- Визуализация прогресса загрузки документов с помощью прогресс-бара
- Возможность отмены загрузки документов
- Просмотр истории диалога и сохранение контекста разговора
- Принудительное пересоздание индекса без перезапуска бота
- Отказоустойчивость и обработка ошибок
- Оптимизация расходов за счет ограничения размера передаваемого контекста

## Требования

- Python 3.8 или выше
- Telegram Bot API ключ
- Yandex Cloud API ключ
- Yandex Cloud Folder ID

## Установка

1. Клонируйте репозиторий:
```
git clone <url-репозитория>
cd <название-репозитория>
```

2. Создайте и активируйте виртуальное окружение:
```
python -m venv venv
source venv/bin/activate  # для Linux/macOS
venv\Scripts\activate     # для Windows
```

3. Установите зависимости:
```
pip install -r requirements.txt
```

4. Создайте файл `.env` на основе `.env.example` и заполните его своими данными:
```
YANDEX_API_KEY=ваш-api-ключ
YANDEX_FOLDER_ID=идентификатор-каталога
TELEGRAM_BOT_TOKEN=токен-телеграм-бота
DEFAULT_TEMPERATURE=0.5
DEFAULT_SYSTEM_PROMPT="Ваш системный промпт для модели"
```

5. Поместите Markdown-файлы, которые хотите использовать для поиска, в папку `./data/md/`.

## Запуск

Запустите приложение командой:
```
python main.py
```

## Использование

1. Найдите своего бота в Telegram по его имени.
2. Используйте команду `/start` для начала общения с ботом.
3. Задавайте вопросы боту, и он будет искать ответы в загруженных Markdown-файлах.

### Доступные команды

- `/start` - Начать общение с ботом
- `/help` - Показать справку
- `/reset` - Сбросить историю разговора
- `/status` - Получить текущий статус загрузки документов
- `/cancel` - Отменить текущую загрузку документов
- `/history` - Показать историю разговора
- `/reindex` - Принудительно пересоздать поисковый индекс

## Структура проекта

- `main.py` - основной файл для запуска приложения
- `telegram_bot.py` - модуль для телеграм-бота
- `document_processor.py` - модуль для загрузки Markdown-файлов в Yandex Cloud
- `session_manager.py` - модуль для управления сессиями и тредами пользователей
- `data/md/` - папка для хранения Markdown-файлов
- `data/index_config.json` - файл с сохраненным ID индекса для повторного использования

## Подготовка документов

Перед использованием приложения подготовьте ваши документы в формате Markdown и поместите их в папку `data/md/`. Убедитесь, что:

1. Файлы имеют расширение `.md`
2. Файлы содержат корректный Markdown-разметку
3. Файлы не пустые
4. Кодировка файлов UTF-8

## Оптимизация работы с индексом

Приложение оптимизировано для повторного использования индекса между запусками:

1. При первом запуске создается индекс и его ID сохраняется в файле `data/index_config.json`
2. При последующих запусках проверяется существование индекса в Yandex Cloud
3. Если индекс существует, он используется без повторной загрузки документов
4. Если индекс не найден, автоматически создается новый
5. Команда `/reindex` позволяет принудительно пересоздать индекс, например, при добавлении новых документов

## Параметры гибридного поиска

Для оптимизации качества поиска используются следующие параметры:
- Размер чанка: 1024 токена
- Перекрытие чанков: 512 токенов
- Комбинирование результатов: ReciprocalRankFusion

## Обработка ошибок

Приложение устойчиво к различным ошибкам:
- Ошибки при загрузке отдельных документов не прерывают обработку остальных
- Возможность работы в режиме обычного ассистента без поиска, если создание индекса не удалось
- Корректная обработка отмены операций и завершения приложения
- Проверка существования директории с Markdown-файлами 