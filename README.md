# Телеграм-бот AI-ассистент с поиском по документам

Данное приложение реализует функционал AI-ассистента с гибридным поиском по документам на основе Yandex Cloud ML SDK. Ассистент работает в виде телеграм-бота и использует технологии Yandex Cloud для работы с документами (Markdown и DOCX файлы) и поиска информации в них.

## Особенности

- Загрузка готовых документов (Markdown и DOCX файлов) в Yandex Cloud и создание гибридного поискового индекса
- Сохранение ID поискового индекса для повторного использования без переиндексации
- Управление сессиями пользователей в телеграм-боте (каждый пользователь общается с AI моделью внутри своего треда)
- Визуализация прогресса загрузки документов с помощью прогресс-бара
- Возможность отмены загрузки документов
- Просмотр истории диалога и сохранение контекста разговора
- Принудительное пересоздание индекса без перезапуска бота
- Отказоустойчивость и обработка ошибок
- Оптимизация расходов за счет ограничения размера передаваемого контекста

## Требования

- Python 3.8 или выше
- Telegram Bot API ключ
- Yandex Cloud API ключ
- Yandex Cloud Folder ID

## Установка

1. Клонируйте репозиторий:
```
git clone <url-репозитория>
cd <название-репозитория>
```

2. Создайте и активируйте виртуальное окружение:
```
python -m venv venv
source venv/bin/activate  # для Linux/macOS
venv\Scripts\activate     # для Windows
```

3. Установите зависимости:
```
pip install -r requirements.txt
```

4. Создайте файл `.env` на основе `.env.example` и заполните его своими данными:
```
YANDEX_API_KEY=ваш-api-ключ
YANDEX_FOLDER_ID=идентификатор-каталога
TELEGRAM_BOT_TOKEN=токен-телеграм-бота
DEFAULT_TEMPERATURE=0.5
DEFAULT_SYSTEM_PROMPT="Ваш системный промпт для модели"
```

5. Поместите документы (Markdown и DOCX файлы), которые хотите использовать для поиска, в папку `./data/md/`.

## Запуск

### Обычный запуск

Запустите приложение командой:
```
python main.py
```

### Запуск в Docker (рекомендуется)

Для удобного развертывания и изоляции приложения рекомендуется использовать Docker.

#### Подготовка к запуску в Docker

1. Убедитесь, что у вас установлен [Docker](https://docs.docker.com/get-docker/) и [Docker Compose](https://docs.docker.com/compose/install/)

2. Создайте файл `.env` на основе `env.example`:
```bash
cp env.example .env
```

3. Отредактируйте файл `.env` и заполните все необходимые переменные:
```bash
nano .env  # или используйте любой другой редактор
```

4. Поместите ваши документы в папку `./data/md/`

#### Быстрое развертывание (рекомендуется)

Используйте автоматический скрипт развертывания:
```bash
./deploy.sh
```

Скрипт автоматически:
- Проверит наличие всех необходимых компонентов
- Создаст .env файл из примера (если отсутствует)
- Создаст директории для документов
- Соберет и запустит Docker контейнер

#### Ручная сборка и запуск

1. Соберите Docker образ:
```bash
docker-compose build
```

2. Запустите контейнер:
```bash
docker-compose up -d
```

3. Проверьте логи работы:
```bash
docker-compose logs -f
```

#### Управление контейнером

```bash
# Остановить контейнер
docker-compose down

# Перезапустить контейнер
docker-compose restart

# Просмотр логов
docker-compose logs -f ai-assistant-md

# Обновление приложения
docker-compose down
docker-compose build --no-cache
docker-compose up -d

# Зайти внутрь контейнера для отладки
docker-compose exec ai-assistant-md bash
```

#### Особенности Docker версии

- **Изоляция**: Приложение работает в изолированном контейнере
- **Автоматический перезапуск**: Контейнер перезапускается при сбоях
- **Ограничения ресурсов**: Настроены ограничения по памяти (1GB) и CPU (0.5 ядра)
- **Логирование**: Логи автоматически ротируются (максимум 3 файла по 10MB)
- **Volumes**: Данные сохраняются между перезапусками контейнера
- **Healthcheck**: Автоматическая проверка работоспособности контейнера

## Использование

1. Найдите своего бота в Telegram по его имени.
2. Используйте команду `/start` для начала общения с ботом.
3. Задавайте вопросы боту, и он будет искать ответы в загруженных документах (Markdown и DOCX файлах).

### Доступные команды

- `/start` - Начать общение с ботом
- `/help` - Показать справку
- `/reset` - Сбросить историю разговора
- `/status` - Получить текущий статус загрузки документов
- `/cancel` - Отменить текущую загрузку документов
- `/history` - Показать историю разговора
- `/reindex` - Принудительно пересоздать поисковый индекс

## Структура проекта

### Основные файлы приложения
- `main.py` - основной файл для запуска приложения
- `telegram_bot.py` - модуль для телеграм-бота
- `document_processor.py` - модуль для загрузки документов (Markdown и DOCX файлов) в Yandex Cloud
- `session_manager.py` - модуль для управления сессиями и тредами пользователей
- `requirements.txt` - зависимости Python

### Docker файлы
- `Dockerfile` - конфигурация для сборки Docker образа
- `docker-compose.yml` - конфигурация для запуска контейнера
- `.dockerignore` - исключения для Docker сборки
- `env.example` - пример файла переменных окружения
- `deploy.sh` - скрипт автоматического развертывания

### Директории и конфигурация
- `data/md/` - папка для хранения документов (Markdown и DOCX файлов)
- `data/index_config.json` - файл с сохраненным ID индекса для повторного использования
- `.env` - файл переменных окружения (создается пользователем)

## Подготовка документов

Перед использованием приложения подготовьте ваши документы и поместите их в папку `data/md/`. Поддерживаются следующие форматы:

### Markdown файлы (.md)
1. Файлы имеют расширение `.md`
2. Файлы содержат корректную Markdown-разметку
3. Файлы не пустые
4. Кодировка файлов UTF-8

### DOCX файлы (.docx)
1. Файлы имеют расширение `.docx`
2. Файлы содержат текстовое содержимое (изображения не обрабатываются)
3. Файлы не повреждены и могут быть открыты
4. DOCX файлы автоматически конвертируются в Markdown перед загрузкой

## Оптимизация работы с индексом

Приложение оптимизировано для повторного использования индекса между запусками:

1. При первом запуске создается индекс и его ID сохраняется в файле `data/index_config.json`
2. При последующих запусках проверяется существование индекса в Yandex Cloud
3. Если индекс существует, он используется без повторной загрузки документов
4. Если индекс не найден, автоматически создается новый
5. Команда `/reindex` позволяет принудительно пересоздать индекс, например, при добавлении новых документов

## Параметры гибридного поиска

Для оптимизации качества поиска используются следующие параметры:
- Размер чанка: 1024 токена
- Перекрытие чанков: 512 токенов
- Комбинирование результатов: ReciprocalRankFusion

## Обработка ошибок

Приложение устойчиво к различным ошибкам:
- Ошибки при загрузке отдельных документов не прерывают обработку остальных
- Возможность работы в режиме обычного ассистента без поиска, если создание индекса не удалось
- Корректная обработка отмены операций и завершения приложения
- Проверка существования директории с документами 